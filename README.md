# Мосты, туннели и VPN

## Задачи

1. Между двумя виртуалками поднять vpn в режимах
- tun
- tap

Прочувствовать разницу.


2. Поднять RAS на базе OpenVPN с клиентскими сертификатами, подключиться с локальной машины на виртуалку


3*. Самостоятельно изучить, поднять ocserv и подключиться с хоста к виртуалке


## Выполнение

### Развертывание стендов
ЧТобы не складывать все в кучу, для каждой задачи была отведена своя директория. Соответственно, для поднятия того или иного стенда необходимо переместиться в его директорию, ориентируясь на ее название и сделать vagrant up.

1. Подключение точка-точка
В обоих стендах работают хосты __s1__ и __s2__. Настроены в равноправных ролях.

### В чем разница
tun создает ip-туннель, tap - ethernet-туннель, что открывает доступ ко второму уровню модели OSI, но при этом, соответственно увеличивается оверхед. Заявлено, что tun более экономный для трафика и процессора, соответственно, использование tun должно показать большую производительность.

### tun
Из соответствующей директории автоматически поднимается и все работает. Для проверки доступности изолированных сетей на каждом хосте дополнительно поднимаются сети 172.16.10.10 на __s1__ и 172.16.20.20 на __s2__. Маршуты к этим сетям поднимаются автоматически и можно проверить их доступность посредством ping.

### tap 
В отличие от типа устройства tun, здесь не получилось поднять маршрут посредством записи в конфиг-файле openvpn, хотя в процессе перепробовал множество различных опций. Пришлось добавить директиву route-up, которая запускает внешний скрипт, уже в котором прописывается необходимый маршрут.   
Чтобы работала директива route-up, необходимо, чтобы запускаемый ей скрипт мог запускаться пользователем, из-под которого работает openvpn, плюс, в конфиге необходимо разрешение на запуск скриптов, которое выдается директивой __script-security 2__ - уровень должен быть 2 или 3, по умолчанию его значение = 1.

### Проверка
Кроме линковых адресов из сети 10.10.10.0/24 (10.10.10.1 для __s1__ и 10.10.10.2 для __s2__.) для проверки отработки маршрутизации были также подняты адреса в изолированных сетях: 172.16.10.10 для __s1__ и 172.16.20.20 для __s2__. Таким образом, основная проверка проходится пингом линковых адресов противоположных сторон, плюс дополнительная - адресов из изолированных сетей.

### Экспериментальное сравнение производительности

*tun
```
[root@s1 ~]# iperf3 -c 172.16.20.20 -i 30
Connecting to host 172.16.20.20, port 5201
[  4] local 10.10.10.1 port 39332 connected to 172.16.20.20 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-10.00  sec  79.8 MBytes  67.0 Mbits/sec   33    138 KBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec  79.8 MBytes  67.0 Mbits/sec   33             sender
[  4]   0.00-10.00  sec  79.2 MBytes  66.4 Mbits/sec                  receiver

iperf Done.
```

*tap
```
[root@s2 ~]# iperf3 -c 172.16.10.10
Connecting to host 172.16.10.10, port 5201
[  4] local 10.10.10.2 port 56746 connected to 172.16.10.10 port 5201
[ ID] Interval           Transfer     Bandwidth       Retr  Cwnd
[  4]   0.00-1.01   sec  8.46 MBytes  70.4 Mbits/sec    0    164 KBytes
- - - - - - - - - - - - - - - - - - - - - - - - -
[ ID] Interval           Transfer     Bandwidth       Retr
[  4]   0.00-10.00  sec  79.3 MBytes  66.6 Mbits/sec   65             sender
[  4]   0.00-10.00  sec  78.8 MBytes  66.1 Mbits/sec                  receiver

iperf Done.
```
Как видно из результата, особой разницы в производительности нет. На практике же при выборе того или иного устройства имеет смысл исходить из поставленных задач, т.к. tun чуть проще в организации, но tap дает больше возможностей - второй уровень иногда необходим. 


2. RAS
Развернув стенд, получаем сервер с openvpn на стандартном (1194) порту. Адрес для подключения 192.168.11.20
Для подключения в директории client имеется файл client.ovpn. Вроде бы его можно использовать в любой системе, правда, нет 100% уверенности насчет MacOS, поэтому на всякий случай в директории client/keys содержатся все необходимые файлы для подключения через обычный конфиг.

### Проверка

Подключаюсь к серверу, смотрю что на сервере в статусе:

```
[root@ras ~]# cat /var/run/openvpn.status
OpenVPN CLIENT LIST
Updated,Sun Jun 28 16:59:47 2020
Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since
client,192.168.11.1:58794,47192,5157,Sun Jun 28 16:51:44 2020
ROUTING TABLE
Virtual Address,Common Name,Real Address,Last Ref
10.10.10.2,client,192.168.11.1:58794,Sun Jun 28 16:54:23 2020
GLOBAL STATS
Max bcast/mcast queue length,0
END
``` 

Проверяю на хостовой машине:

```
zrad@zrDell:~$ ip ro | grep 172.16
none 172.16.10.0/24 via 10.10.10.1 dev eth6 proto unspec metric 0

zrad@zrDell:~$ ping 172.16.10.10
PING 172.16.10.10 (172.16.10.10) 56(84) bytes of data.
64 bytes from 172.16.10.10: icmp_seq=1 ttl=64 time=0.730 ms
64 bytes from 172.16.10.10: icmp_seq=2 ttl=64 time=0.825 ms
^C
--- 172.16.10.10 ping statistics ---
2 packets transmitted, 2 received, 0% packet loss, time 1001ms
rtt min/avg/max/mdev = 0.730/0.777/0.825/0.055 ms
```

Что говорит об успешном подключении и и том, что все маршруты работают и изолированная сеть доступна.


### Для Windows хостов 
Если в системе уже есть активное openvpn соединение, при попытке подключиться будет получаена ошибка "All windows tap adapters currently in use" и соединение не состоится. В этом случае можно использовать готовый скрипт:
```
C:\Program Files\TAP-Windows\bin\addtap.bat
```

### Для отзыва сертификата
В случае, если для одного из клиентов потребуется заблокировать доступ, можно воспользоваться отзывом сертификата:
./easyrsa revoke client
